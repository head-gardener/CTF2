# CTF2
The site for "Capture The Flag" local tournament in BSU FAMCS CryptoSec scpeciality

## Дизайн

Приложение разработанно с упором на т.н. "high availability" и состоит из множества
отдельных сервисов, выполняющих разные задачи. Основные сложности в разработке подобных
систем заключаются в создании безопасных протаколов обмена информацией между раздельными
приложениями. Решению подобных задач была посвящена представленная работа.

### Виды сервисов

При развертывании, помимо разработанных сервисов, были использованны и сторонние:
- К разработанным относятся `ctf` и `casino`.
- К сторонним относятся все прочие сервисы: `postgres`, `prometheus`, `minio`, `k3s`, `traefik`, `nginx` и т.д.

Это разделение используется в основном для безопасного 
Задачи, решаемые сервисами, достаточно обширны. Вот некоторые из них:
- Предоставление интерфейса конечным пользователям (`ctf`, `casino`)
- Хранение данных, файлов (`postgres`, `minio`)
- Хранение и обработка метрик (`prometheus`, `postgres-exporter`, `grafana`)
- Виртуализация, оркестрация контейнеров (`k3s`)
- Обратные прокси (`nginx`, `traefik`)

По отношению к развертыванию, сервисы можно поделить на внутренние и внешние. Внутренние
сервисы разворачиваются непосредственно на время работы приложения, внешние сервисы доступны
вне зависимости от его работы. Ключевая особенность внутренних сервисов в том, что они находятся
в единой виртуальной сети и имеют полный доступ друг к другу. Конечный пользователь может
взаимодействовать с сервисами в этой виртуальной сети только когда обратный прокси перенаправляет
его запросы на этот сервис - иначе говоря все публично доступные сервисы определены во время
развертывания, остальные сервисы остаются недоступными. Внешние сервисы в свою очередь
доступны в глобальной сети.
- К внешним сервисам относятся `minio` (`s3.backyard-hg.xyz`), `nginx` (`*.backyard-hg.xyz`)
  и `grafana` (`grafana.backyard-hg.xyz`).
- К внутренним сервисам относятся все остальные.

Это разделение используется в основном для сборки метрик, доступных только внутри виртуальной
сети. Например `ctf` реализует endpoint `/metrics`, доступный только по адресам интерфейсов,
иначе говоря в виртуальной сети. Сама вируальная сеть предоставляется сервисом `k3s`.

### Разработанные сервисы

#### CTF

Основной сервис, реализующий сам интерфейс соревнования. Кроме предоставления задач сервис
выполняет задачу обработки данных пользователей, их регистрации и аутентификации.

В разработке был использован язык `python` и популярный фреймворк `django`, средствами которого
были реализованы все вышеуказанные задачи.

#### Casino

Вспомогательный сервис, выполняющий функцию реализации очков, заработанных пользователями,
в косметические награды в игровой форме.

В разработке был использован язык `haskell` и фреймворк `Yesod`. Аутентификация пользователей
была делегированна `ctf`, который поставляет jwt, позволяющиe пользователям получить сессию.
Для подписей токенов был использован алгоритм `HMAC` по причине просты его использования и
интеграции с названными фреймворками.

Для синхронизации информации о пользователях используется простой API, пользователи которого
должны пройти авторизацию в зависимости от функции endpoint-а. Для административных функций
используется общий секрет `ctf` и `casino`, передаваемый в хешированном виде, или jwt. Для
функционала пользовательского интерфейса достаточно сессии.

## Развертывание

Важным свойством разработанных сервисов является отсутствие значимого внутреннего состояния.
Это гарантирует, что удаление контейнера с таким сервисом и повторное создание никак не
отразится на конечных пользователях. Все необходимое состояние хранится снаружи в базе данных,
информация которой в свою очередь подвержена репликации и бекапам. Это централизует состояние
приложения и упрощает предотвращение и разрешение катастроф.

Для хранения секретов в общем доступе было использовано `gpg` шифрование. Для создания
контейнеров и их оптимизации были использованы средства языка `nix`.

Более подробно со спецификацией развертывания, написанной для k3s, можно ознакомиться в
директориях `infra` и `nix`.
