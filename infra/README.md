# Развертывание

## Вам понадобится:

- домен с tls сертификатами
- рабочий кластер k8s с настроенным ингрессом (e.g. `traefik`) и `local-path-provisioner`, например `k3s`
- s3, мы писали под minio
- postgresql

> Можно обойтись без домена и k8s, но с развертыванием в этом случае разбирайтесь сами.

Опционально:
- nix: для сборки проектов и контейнеров
- prometheus: для сборки метрик
- локальный docker registry: для передачи изображений на k8s
- just: для чтения justfile
- gpg или openssl: для хранения секретов

Для сборки без nix:
- docker
- poetry
- cabal

## Содержимое репозитория

- `ctf`: собственно ctf, основной сервис
- `casino`: казино, сопровождающий сервис
- `infra`: файлы k8s объектов
- `nix`: дополнительные nix файлы

Кроме того, в корне лежат
- файлы `poetry`, используемые для сборки `ctf` (`pyproject.toml`, `poetry.lock`)
- флейк, используемый nix-ом (`flake.nix`, `flake.lock`) - универсальной системой сборки.
- `justfile`, описывающий комманды `just` (аналог `make`)

## Сопровождающие иснтрументы

### Nix

В этом репозитории nix используется для сборки обоих проектов (`ctf` на `poetry` и `casino` на хаскеле), а также для создания контейнеров. Можно обойтись без него, но dockerfile придется писать заново - подсказки находятся в `nix/image.nix`.

### Just

В репозитории есть несолько `justfile`, удобных для разработки. Команды из них можно скопировать дословно и использовать в другом формате (с учетом аргументов, вида `{{target}}`).

### GPG

Некоторые файлы в папке `infra` (`*-secret.yaml`) зашифрованы gpg и содержат секреты, в частности ключ postgres, minio и django. Без ключей вам придется создать новые, и если надобности в шифровании не возникнет, то можно обойтись и без шифрования. Примеры того, как эти файлы должны выглядеть, можно найти в `infra/examples`.

## Сервисы

> Инструкции для сборки ниже подразумевают, что вы не используете никс. В случае с никсом используйте `nix build .#default` и `nix build .#casino` для сборки ctf и casino соответвенно, и `nix build .#image-ctf` и `nix build .#image-casino` для создания docker-изображений.

> Переменные окружения есть в файлах k8s, но некоторые из них придется поменять на используемые вами, например домены. Ниже указанны не все используемые переменные, но только те, которые прописанны в файлах k8s.

### ctf

> В файлах k8s этот сервис называетс `django`.

Стандартный порт: `8000`.

Основной сервис написан на питоне и django, используйте `poetry` для загрузки всех зависимотей и запускайте через `manage.py`. Последовательность нужных для запуска команд есть в `nix/image.nix`.

Кроме `manage.py` в папке `ctf` находится `load_tasks.py` - скрипт, использующийся для получния информации о заданиях с s3 и передачи их в postgres. Его запуск в кластере производится через задачу (`job`) `django-load-tasks`, описанную в `infra/django-load-tasks.yaml`.

Обратите внимание на то, что основной сервис и скрипт используют разные ключи для доступа к s3 - сервису достаточно ro ключа, в то время как скрипт использует rw (не спрашивайте зачем). В переменных окружения они разделенны на `MINIO_USER_*_KEY` для ro и `MINIO_*_KEY` для rw.

Переменные окружения:
- `ALLOWED_HOSTS`: адреса, по которым разрешенно вызывать сервер, например - `ctf.backyard-hg.xyz`
- `CASINO_HOST`: адрес, по которому доступен casino, например - `https://casino.backyard-hg.xyz`
- `CSRF_TRUSTED_ORIGINS`: доверенные источники CSRF, в отличие от `ALLOWED_HOSTS` должно содержать протокол (`https`), например - `https://ctf.backyard-hg.xyz`
- `UNRESTRICT_INTERFACES`: `/metrics` доступен только с *unrestricted* адресов, используйте эту переменную чтобы занести все IP адреса интерфейсов в этот список. Пример - `1`
- `DJANGO_DEBUG`: дебаг-режим django, пример - `0`
- `DJANGO_SECRET_KEY`: секрет, использующийся django для чего-то и нами для обмена информацией с casino через jwt. Пример - `secret`.
- `POSTGRES_HOST`: адрес, по которому доступен postrgesql, например - `postgres-db`
- `POSTGRES_USER`: пользователь postgresql, например - `ctf`
- `POSTGRES_PASSWORD`: пароль для доступа к postgres, например - `password`
- `MINIO_URL`: адрес, по которому доступен minio, например - `s3.example.xyz`
- `MINIO_BUCKET`: s3 бакет, в котором находятся файлы, например - `ctf`
- `MINIO_USER_ACCESS_KEY`: имя minio пользователя с ro правами, например - `user`
- `MINIO_USER_SECRET_KEY`: пароль minio пользователя с ro правами, например - `password`
- `MINIO_ACCESS_KEY`: имя minio пользователя с rw правами, например - `user`
- `MINIO_SECRET_KEY`: пароль minio пользователя с rw правами, например - `password`

В файлах k8s эти переменные прописанны в следующих файлах, по порядку перечисления переменных выше: `django-config.yaml`, `django-secret.yaml`, `postgres-config.yaml`, `postgres-secret.yaml` и `minio-secret.yaml`.

Другие связанные k8s файлы: `django.yaml`, `django-load-tasks.yaml`.

### casino

Стандартный порт: `3031`.

Сопровождающий сервис, написан на хаскеле. Не является строго необходимым - без него придется удалить все элементы интерфейса ctf, которые на него ссылаются, и вызовы к его API. Для сборки используйте `cabal`, `cabal build` должен сработать. 

Переменные окружения:
- `POSTGRES_HOST`: адрес, по которому доступен postrgesql, например - `postgres-db`
- `POSTGRES_USER`: пользователь postgresql, например - `ctf`
- `POSTGRES_PASSWORD`: пароль для доступа к postgres, например - `password`
- `PROVIDER_SECRET`: секрет, переданный django в переменной `DJANGO_SECRET_KEY`. Используется для проверки jwt. Пример - `secret`.

В файлах k8s эти переменные прописанны в следующих файлах, по порядку перечисления переменных выше: `postgres-config.yaml`, `postgres-secret.yaml` и `django-secret.yaml`.

Другие связанные k8s файлы: `casino.yaml`.

### Postgresql

Используется для хранения информации о сервисх, пользователях и заданиях. В k8s настроен на использовние local-path-provisioner, что позволяет делать бекапы простым копированием файлов - если есть время и вычислительные возмоности переведите его на `longhorn`.

Переменные окружения:
- `POSTGRES_USER`: пользователь postgresql, например - `ctf`
- `POSTGRES_PASSWORD`: пароль для доступа к postgres, например - `password`

В файлах k8s эти переменные прописанны в следующих файлах, по порядку перечисления переменных выше: `postgres-config.yaml` и `postgres-secret.yaml`.

Другие связанные k8s файлы: `postgres.yaml`.

### postgres-exporter

Экспортирует метрики `postgresql` для `prometheus`.

Переменные окружения:
- `DATA_SOURCE_URI`: адрес, по которому доступен postgresql с указанием `sslmode` (чаще всего `disable`), например - `postgres-db?sslmode=disable`)
- `DATA_SOURCE_USER`: пользователь postgresql, например - `ctf`
- `DATA_SOURCE_PASS`: пароль для доступа к postgres, например - `password`

Другие связанные k8s файлы: `postgres-exporter.yaml`.

### Minio

Используется для хранения некоторых статических файлов (лого) и информации о задачах, включая прилогающиеся к ним файлы. Текущая инфраструктура написанна для использования именно minio, но переход на s3 из aws должен быть относительно безболезненным (за вычетом переписывания кода из `ctf`, выполняющего запросы - `ctf/task/minio_client.py`).

В нашем случае `minio` был доступен как внешний сервис, так что в файлы развертывания он не входит.

Структура файлов, ожидаемая сервисами:
- `task3.json`: описывает задания в формате, который мы рассмотрим ниже.
- `logo.png`: лого, отображаемое в хедере сайта.
- остальные файлы - файлы заданий, пути до которых указанны в `task3.json`.

### Prometheus

Собирает метрики с `postgres-exporter`, `ctf` и `casino`. Поды, экспортирующие метрики, отмечены `scrape: true` в лейблах. Рекомендованный способ обнаружения сервисов - service-discovery по endpoint.

### Ингресс

Можно использовать любой, `traefik` поставляется с `k3s`. Используется для перенаправления запросов на `ctf` и `casino`.

### Docker registry

Поскольку для получния изображений k8s требует адреса в registry, мы разворачивали его локально через `docker`. Поменяйте адреса в определениях подов на те, которые используете.

## Формат данных

Данные заданий хранятся на s3 в json-файле `task3.json` co следующим форматом:

```json
{
  "task1": {
    "title": "easy task without an attachment",
    "description": "type 'answer'",
    "answer": "answer",
    "points": 1,
  },
  "task2": {
    "title": "very hard task with an attachment",
    "description": "use attachment",
    "answer": "1234567",
    "points": 4,
    "file_name": "file.txt"
  }
}
```

Награды за задачи (записанные в поле `points`) ранжируются от 1 - простые, до 4 - самые сложные. `file_name` должен быть именем файла в корне бакета s3, или отсутствовать - если файл не нужен. `description` поддерживает `\n` для разделения строк. `task*` - названия полей корневого объекта, - могут быть произвольными и нигде не используются.

## Порядок развертывания

1. домен
1. убедиться, что все переменные окружения корректно выставлены
1. `k3s`
1. `prometheus`
1. `postgesql`
1. `postges-exporter`
1. `casino`
1. `django-load-tasks`
1. `django`
